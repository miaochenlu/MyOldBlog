# 4. 分配方法

## 4.1 连续分配

{:.info}

每个文件在磁盘上占有一组连续的块。

<img src="/Users/jones/Library/Application Support/typora-user-images/image-20191208110156876.png" alt="image-20191208110156876" style="zoom:45%;" />

文件的连续分配可以用第一块的磁盘地址和连续块的数量来定义。如directory中所示，一个文件需要有[start, length]这样一对信息

`优点`{:.success}

* 性能良好。假设只有一个作业访问磁盘，在访问块b后访问块b+1通常不需要移动磁头，需要时一般也只需要移动一个磁道。寻道数少
* 支持顺序访问和直接访问。要顺序访问，文件系统会记住上次访问过的块

`缺点`{:.error}

* 难以为新文件找到空间
* 外部碎片
* 难以确定一个文件需要多少空间
  * 分配太小-->难以扩展

<br/>

## 4.2 链接分配[linked allocation]

{:.info}

每个文件是磁盘块的链表。目录包括文件第一块的指针和最后一块的指针

如图：一个有5块的文件，从块9开始，然后是块16， 1， 10， 最后是25。

<img src="/Users/jones/Library/Application Support/typora-user-images/image-20191207100135972.png" alt="image-20191207100135972" style="zoom:45%;" />

* 要创建新文件，可以简单地在目录中增加一个entry。

  每个directory entry都有一个指向文件首块的指针，这个指针初始化为nil，表示空文件

* 要写文件，空闲空间管理系统会找到一个空闲块，然后这个空闲块被写入并且链接到文件到尾部。
* 要读文件，可以通过块到块的指针



`优点`{:.success}

* 没有外部碎片
* 粗昂见文件时，不需要说明文件大小，只要有空闲块，文件iu可以增大

`缺点`{:.error}

* 只能顺序访问
* 每个块中的指向下一个块的指针都需要占用空间
* 可靠性问题。因为指针分布在整个磁盘上，如果指针丢失或损坏，会导致链接空闲空间列表或者另一个文件

<img src="/Users/jones/Library/Application Support/typora-user-images/image-20191208120328197.png" alt="image-20191208120328197" style="zoom:40%;" />

<br/>

## 4.3 索引分配[indexed allocation]

连续分配和链接分配的问题

{:.error}

链接分配可以解决连续分配的***<u>外部碎片</u>***和***<u>大小声明</u>***问题。但是如果不用FAT，那么链接分配是不能有效支持***<u>直接访问</u>***的，因为块指针和块一起分布在整个磁盘，必须按顺序读取。

索引分配通过把所有文件块的指针放在一个***<u>索引块</u>***，解决了这个问题

* 索引块是一个磁盘块地址的数组，<u>索引块的第i个entry指向文件的第i个块</u>

  <img src="/Users/jones/Library/Application Support/typora-user-images/image-20191208122209693.png" alt="image-20191208122209693" style="zoom: 3%;" />

* directory entry包括索引块的地址

<br/>

> 创建文件时，索引块的所有指针都为nil。
>
> 当首次写入第i块，先从空闲空间管理器中得到一块，再将其地址写到索引块的第i个entry
>
> 如果要读第i块，通过索引块的第i个entry

<img src="/Users/jones/Library/Application Support/typora-user-images/image-20191207102636309.png" alt="image-20191207102636309" style="zoom:50%;" />





### 如何组织索引块

* Linked scheme

  {:.info}

  为了处理大文件，可以将多个***<u>索引块链接</u>***起来

  an index block might contain 

  * a small header giving the name of the file 

  * a set of the first 100 disk-block addresses.

  * The next address (the last word in the index block) is null (for a small file) or is a pointer to another index block (for a large file).

* Multilevel index

  {:.info}

  第一层索引块指向一组第二层的索引块，第二层的索引块再指向文件块。

  为了访问一个块，操作系统通过第一层索引查找到第二层索引，再用第二层索引查找所需的数据块。

  <img src="/Users/jones/Library/Application Support/typora-user-images/image-20191208122123461.png" alt="image-20191208122123461" style="zoom:40%;" />

* combined scheme[**UNIX UFS**]

  将索引块的头15个指针存在文件的inode中。

  1. 12个指向直接块，直接访问数据块

  2. 1个一级间接块
  3. 1个二级间接块
  4. 1个三级间接块

<img src="/Users/jones/Library/Application Support/typora-user-images/image-20191208122503426.png" alt="image-20191208122503426" style="zoom:50%;" />







<img src="/Users/jones/Library/Application Support/typora-user-images/image-20191208123006518.png" alt="image-20191208123006518" style="zoom:40%;" />















